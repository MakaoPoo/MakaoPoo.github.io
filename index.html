<!DOCKTYPE html>

<html lang="ja">
<head>
  <title>真姫ちゃんクソゲーかきくけこ</title>
  <link rel="shortcut icon" href="maki_chan/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta charset="utf-8" content="width=device-width, user-scale=yes, initial-scale=1.0, maximum-scale=1.0">
  <script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
      // 登録成功
      // console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }).catch(function(err) {
      // 登録失敗 :(
      console.log('ServiceWorker registration failed: ', err);
    });

    var backGraph = new Image();
    backGraph.src = "maki_chan/back.png";
    var hairGraph = new Image();
    hairGraph.src = "maki_chan/hair.png";
    var browGraph = new Array(4);
    var eyeGraph = new Array(4);
    var mouthGraph = new Array(4);
    for(var i=0; i<4; i++) {
      var index = i+1
      browGraph[i] = new Image();
      browGraph[i].src = "maki_chan/brow"+ index +".png";
      eyeGraph[i] = new Image();
      eyeGraph[i].src = "maki_chan/eye"+ index +".png";
      mouthGraph[i] = new Image();
      mouthGraph[i].src = "maki_chan/mouth"+ index +".png";
    }
  }
  </script>
</head>

<body>
  <canvas id="canvas"></canvas>
  <AUDIO id="vee1-1" src="maki_chan/VEE1.wav"></AUDIO>
  <AUDIO id="vee1-2" src="maki_chan/VEE1.wav"></AUDIO>
  <AUDIO id="vee1-3" src="maki_chan/VEE1.wav"></AUDIO>
  <AUDIO id="vee2" src="maki_chan/VEE2.wav"></AUDIO>
  <AUDIO id="bgm" src="maki_chan/BGM.mp3"></AUDIO>

  <script>
  var width = 640;
  var height = 480;
  var scale = 1;
  var startFrame = -1;
  var brow = 0, eye = 0, mouth = 0;
  var gamePart = 0;
  var count = 0;
  var veeCount = 0;
  var touch = false;

  function main(){
    var day = new Date();
    var lastFrame = day.getTime();
    var frame = (lastFrame-startFrame);
    if(frame < 0 || startFrame == -1) frame =0;
    startFrame = lastFrame;
    guruguru(frame);
    if(gamePart == 4) {
      document.getElementById('bgm').play();
      if(document.getElementById('bgm').currentTime > 20) {
        gamePart = 5;
        scale  = 1;
      }
      scale += frame/10000;
    }
    draw();
    setTimeout(main, 0);
  }
  function draw() {
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext('2d');

    canvas.setAttribute("width", width);
    canvas.setAttribute("height", height);

    var sc;
    var cx = width/2;
    var cy = height/2;
    if(height / width < 0.75) {
      ctx.font =  height/9+"px 'ＭＳ ゴシック'";
      sc = height/480;
    } else {
      ctx.font =  width/12+"px 'ＭＳ ゴシック'";
      sc = width/640;
    }
    if(gamePart < 5) {
      var sx, sy, sw ,sh;
      sx = cx + (-320 + 0)*scale*sc; sy = cy + (-240 + 0)*scale*sc;
      sw = 640*sc*scale; sh = 480*sc*scale;
      ctx.drawImage(backGraph,sx ,sy ,sw ,sh );
      if(brow != -1) {
        sx = cx + (-320 + 180)*scale*sc; sy = cy + (-240 + 150)*scale*sc;
        sw = 260*sc*scale; sh = 70*sc*scale;
        ctx.drawImage(browGraph[brow],sx ,sy ,sw ,sh );
      }
      if(eye != -1) {
        sx = cx + (-320 + 180)*scale*sc; sy = cy + (-240 + 190)*scale*sc;
        sw = 260*sc*scale; sh = 100*sc*scale;
        ctx.drawImage(eyeGraph[eye],sx ,sy ,sw ,sh );
      }
      if(mouth != -1) {
        sx = cx + (-320 + 270)*scale*sc; sy = cy + (-240 + 310)*scale*sc;
        sw = 90*sc*scale; sh = 50*sc*scale;
        ctx.drawImage(mouthGraph[mouth],sx ,sy ,sw ,sh );
      }
          sx = cx + (-320 + 0)*scale*sc; sy = cy + (-240 + 0)*scale*sc;
      sw = 640*sc*scale; sh = 480*sc*scale;
      ctx.drawImage(hairGraph,sx ,sy ,sw ,sh );
    } else {
      ctx.fillStyle="#ffffff";
      ctx.fillText("真姫ちゃんかわいい", cx-300*sc, cy+70*sc);
    }
  }
  function guruguru(frame) {
    var speed = 150/frame;
    count++;
    switch(gamePart) {
    case 1:
      if(count > speed) count = 0;
      if (count == 0) {
        brow = (brow + 1) % 4;
        if(!touch) {
          veeCount = (veeCount+1)%3;
          document.getElementById('vee1-'+(veeCount+1)).currentTime = 0;
          document.getElementById('vee1-'+(veeCount+1)).play();
        }
      }
      break;
    case 2:
      if(count > speed/2) count = 0;
      if (count == 0) {
        mouth = (mouth + 1) % 4;
        if(document.getElementById('vee2').currentTime>0.58 && !touch) {
          veeCount = (veeCount+1)%3;
          document.getElementById('vee1-'+(veeCount+1)).currentTime = 0;
          document.getElementById('vee1-'+(veeCount+1)).play();
        }
      }
      break;
    case 3:
      if(count > speed/4) count = 0;
      if (count == 0) {
        eye = (eye + 1) % 4;
        if(document.getElementById('vee2').currentTime>0.58 && !touch) {
          veeCount = (veeCount+1)%3;
          document.getElementById('vee1-'+(veeCount+1)).currentTime = 0;
          document.getElementById('vee1-'+(veeCount+1)).play();
        }
      }
      break;
    }
    if(touch) {
      if(gamePart < 4) {
        if(gamePart > 0) {
          for(var i = 0; i<3; i++) {
            document.getElementById('vee1-'+(i+1)).pause();
          }
          document.getElementById('vee2').currentTime = 0;
          document.getElementById('vee2').play();
        }
        gamePart++;
        count = -1;
      }
      touch = false;
    }
  }
  $(window).resize(function() {
    width = $('body').width();
    height = $('body').height();
    draw();
  })
  $(window).on('load', function(){
    document.getElementById('vee1-1').volume = 0.5;
    document.getElementById('vee1-2').volume = 0.5;
    document.getElementById('vee1-3').volume = 0.5;
    document.getElementById('vee1-4').volume = 0.5;
    document.getElementById('vee2').volume = 0.5;

    width = $('body').width();
    height = $('body').height();

    var device = ["iPhone", "iPad", "iPod", "Android"];
    for(var i=0; i<device.length; i++){
      if (navigator.userAgent.indexOf(device[i])>0){
        $('#canvas').on('touchend', function() {
          if(gamePart == 0) {
            start();
          }
        });
        $('#canvas').on('touchstart', function() {
          touch = true;
        });
        break;
      }
      if(i == device.length-1) {
        $('#canvas').on('mousedown', function() {
          if(gamePart == 0) {
            start();
          }
          touch = true;
        });
      }
    };
    brow = getRand(0,3);
    eye = getRand(0,3);
    mouth = getRand(0,3);
    draw();
  });
  function start(){
    document.getElementById('vee1-1').load();
    document.getElementById('vee1-2').load();
    document.getElementById('vee1-3').load();
    document.getElementById('vee1-4').load();
    document.getElementById('vee2').load();
    document.getElementById('bgm').load();

    brow = 0;
    eye = -1;
    mouth = -1;
    main();
  }
  function getRand(max, min){
    var rand = Math.floor( Math.random() * (max + 1 - min) ) + min ;
    return rand;
  }
  </script>

  <style>
  html {
  user-select: none;
  }
  body {
    position: fixed;
    width: 100%;
    height: 100%;
    overflow: hidden;
    margin: 0px;
    background: #000;
  }
  #canvas {
  }
  img {
    position: absolute;
    visibility: hidden;
  }
  p {
    visibility: hidden;
    position: absolute;
    top: 0;
    left: 0;
    color: #fff;
    vertical-align: middle;
    font-size: 8vmin;
  }
  </style>
</body>
</html>
