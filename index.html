<!DOCKTYPE html>

<html lang="ja">
<head>
  <title>真姫ちゃんクソゲーかきくけこ</title>
  <link rel="shortcut icon" href="maki_chan/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta charset="utf-8" content="width=device-width, user-scale=yes, initial-scale=1.0, maximum-scale=1.0">
  <script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
      // 登録成功
      // console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }).catch(function(err) {
      // 登録失敗 :(
      console.log('ServiceWorker registration failed: ', err);
    });

    var backGraph = new Image();
    backGraph.src = "maki_chan/back.png";
    var hairGraph = new Image();
    hairGraph.src = "maki_chan/hair.png";
    var browGraph = new Array(4);
    var eyeGraph = new Array(4);
    var mouthGraph = new Array(4);
    for(var i=0; i<4; i++) {
      var index = i+1;
      browGraph[i] = new Image();
      browGraph[i].src = "maki_chan/brow"+ index +".png";
      eyeGraph[i] = new Image();
      eyeGraph[i].src = "maki_chan/eye"+ index +".png";
      mouthGraph[i] = new Image();
      mouthGraph[i].src = "maki_chan/mouth"+ index +".png";
    }
  }
  </script>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script>
  var context = null;
  var soundBuffList = {};
  var soundList = {
    vee1: "maki_chan/VEE1.wav",
    vee2: "maki_chan/VEE2.wav",
    bgm : "maki_chan/BGM.mp3"
  }
  var width = 640;
  var height = 480;
  var scale = 1;
  var startFrame = -1;
  var brow = 0, eye = 0, mouth = 0;
  var gamePart = 0;
  var count = 0;
  var touch = false;
  var playingVee1 = [];
  var startTime = 0;
  var prevSoundTime = 0;
  var notFirstSound = false;

  function main(){
    var day = new Date();
    var lastFrame = day.getTime();
    var frame = (lastFrame-startFrame);
    if(frame < 0 || startFrame == -1) frame =0;
    startFrame = lastFrame;
    guruguru(frame);
    if(gamePart == 4) {
      if(!notFirstSound) {
          playSound("bgm");
          notFirstSound = true;
      }
      if(getCurrentTime() > 20) {
        gamePart = 5;
        scale  = 1;
      }
      scale += frame/10000;
    }
    draw();
    setTimeout(main, 0);
  }
  function draw() {
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext('2d');

    canvas.setAttribute("width", width);
    canvas.setAttribute("height", height);

    var sc;
    var cx = width/2;
    var cy = height/2;
    if(height / width < 0.75) {
      ctx.font =  height/9+"px 'ＭＳ ゴシック'";
      sc = height/480;
    } else {
      ctx.font =  width/12+"px 'ＭＳ ゴシック'";
      sc = width/640;
    }
    if(gamePart < 5) {
      var sx, sy, sw ,sh;
      sx = cx + (-320 + 0)*scale*sc; sy = cy + (-240 + 0)*scale*sc;
      sw = 640*sc*scale; sh = 480*sc*scale;
      ctx.drawImage(backGraph,sx ,sy ,sw ,sh );
      if(brow != -1) {
        sx = cx + (-320 + 180)*scale*sc; sy = cy + (-240 + 150)*scale*sc;
        sw = 260*sc*scale; sh = 70*sc*scale;
        ctx.drawImage(browGraph[brow],sx ,sy ,sw ,sh );
      }
      if(eye != -1) {
        sx = cx + (-320 + 180)*scale*sc; sy = cy + (-240 + 190)*scale*sc;
        sw = 260*sc*scale; sh = 100*sc*scale;
        ctx.drawImage(eyeGraph[eye],sx ,sy ,sw ,sh );
      }
      if(mouth != -1) {
        sx = cx + (-320 + 270)*scale*sc; sy = cy + (-240 + 310)*scale*sc;
        sw = 90*sc*scale; sh = 50*sc*scale;
        ctx.drawImage(mouthGraph[mouth],sx ,sy ,sw ,sh );
      }
          sx = cx + (-320 + 0)*scale*sc; sy = cy + (-240 + 0)*scale*sc;
      sw = 640*sc*scale; sh = 480*sc*scale;
      ctx.drawImage(hairGraph,sx ,sy ,sw ,sh );
    } else {
      ctx.fillStyle="#ffffff";
      ctx.fillText("真姫ちゃんかわいい", cx-300*sc, cy+70*sc);
    }
  }
  function guruguru(frame) {
    var speed = 150/frame;
    count++;
    switch(gamePart) {
    case 1:
      if(count > speed) count = 0;
      if (count == 0) {
        brow = (brow + 1) % 4;
        if(!touch) {
          var span = getCurrentTime() - prevSoundTime;
          if(notFirstSound){
            playSound("vee1", span*4);
          }
          notFirstSound = true;
          prevSoundTime = getCurrentTime();
        }
      }
      break;
    case 2:
      if(count > speed/2) count = 0;
      if (count == 0) {
        mouth = (mouth + 1) % 4;
        if(getCurrentTime() > 0.58 && !touch) {
          var span = getCurrentTime() - prevSoundTime;
          if(notFirstSound){
            playSound("vee1", span*2.2);
          }
          notFirstSound = true;
          prevSoundTime = getCurrentTime();
        }
      }
      break;
    case 3:
      if(count > speed/4) count = 0;
      if (count == 0) {
        eye = (eye + 1) % 4;
        if(getCurrentTime()> 0.58 && !touch) {
          var span = getCurrentTime() - prevSoundTime;
          if(notFirstSound){
            playSound("vee1", span*3);
          }
          notFirstSound = true;
          prevSoundTime = getCurrentTime();
        }
      }
      break;
    }
    if(touch) {
      if(gamePart < 4) {
        if(gamePart > 0) {
          playSound("vee2");
          notFirstSound = false;
        }
        gamePart++;
        count = -1;
      }
      touch = false;
    }
  }
  $(window).resize(function() {
    width = $('body').width();
    height = $('body').height();
    draw();
  })

  $(window).on('load', function(){
    width = $('body').width();
    height = $('body').height();

    var device = ["iPhone", "iPad", "iPod", "Android"];
    for(var i=0; i<device.length; i++){
      if (navigator.userAgent.indexOf(device[i])>0){
        $('#canvas').on('touchend', function() {
          if(gamePart == 0) {
            start();
          }
        });
        $('#canvas').on('touchstart', function() {
          touch = true;
        });
        break;
      }
      if(i == device.length-1) {
        $('#canvas').on('mousedown', function() {
          if(gamePart == 0) {
            start();
          }
          touch = true;
        });
      }
    };
    brow = getRand(3,0);
    eye = getRand(3,0);
    mouth = getRand(3,0);
    draw();
  });
  function start(){
    initWebAPI();
    loadSound("vee1");
    loadSound("vee2");
    loadSound("bgm");

    brow = 0;
    eye = -1;
    mouth = -1;
    main();
  }

  function initWebAPI() {
    try {
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      context = new AudioContext();
    }
    catch(e) {
      context = null;
      alert("このブラウザではWeb Audio APIがサポートされていません。");
    }
  }

  function loadSound(name){
    if (!context) { return; }
    var request = new XMLHttpRequest();
    var url = soundList[name];
    request.open('GET', url, true);
    request.responseType = 'arraybuffer';
    request.onload = function() {
      context.decodeAudioData(
        request.response,
        function(buffer) {
          soundBuffList[name] = buffer;
        },
        function() {
          alert("音声ファイルの読み込みに失敗しました。");
        });
    }
    request.send();
  }

  function playSound(name, time=-1){
    if (!soundBuffList) { return; }
    var source = context.createBufferSource();
    source.buffer = soundBuffList[name];
    source.connect(context.destination);
    if(time > 0) {
      source.start(0,0,time);
    } else {
      source.start(0);
    }

    if(name == "vee2" || name == "bgm") {
      startTime = context.currentTime
    }
  }

  function getCurrentTime() {
    return context.currentTime - startTime;
  }

  function getRand(max, min){
    var rand = Math.floor( Math.random() * (max + 1 - min) ) + min ;
    return rand;
  }
  </script>

  <style>
  html {
  user-select: none;
  }
  body {
    position: fixed;
    width: 100%;
    height: 100%;
    overflow: hidden;
    margin: 0px;
    background: #000;
  }
  </style>
</body>
</html>
