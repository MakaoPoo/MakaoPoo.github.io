<!DOCKTYPE html>

<html lang="ja">
<head>
  <title>真姫ちゃんクソゲーかきくけこ</title>
  <link rel="shortcut icon" href="maki_chan/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta charset="utf-8" content="width=device-width, user-scale=yes, initial-scale=1.0, maximum-scale=1.0">
  <script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
      // 登録成功
      // console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }).catch(function(err) {
      // 登録失敗 :(
      console.log('ServiceWorker registration failed: ', err);
    });

    var backGraph = new Image();
    backGraph.src = "maki_chan/back.png";
    var hairGraph = new Image();
    hairGraph.src = "maki_chan/hair.png";
    var browGraph = new Array(4);
    var eyeGraph = new Array(4);
    var mouthGraph = new Array(4);
    for(var i=0; i<4; i++) {
      var index = i+1
      browGraph[i] = new Image();
      browGraph[i].src = "maki_chan/brow"+ index +".png";
      eyeGraph[i] = new Image();
      eyeGraph[i].src = "maki_chan/eye"+ index +".png";
      mouthGraph[i] = new Image();
      mouthGraph[i].src = "maki_chan/mouth"+ index +".png";
    }
    var audioSourceList = {
      vee1:"maki_chan/VEE1.wav",
      vee2:"maki_chan/VEE2.wav",
      bgm:"maki_chan/BGM.mp3"
    };
    var audioList = {};
    for(var key in audioSourceList) {
      audioList[key] = new Audio(audioSourceList[key]);
    }
  }
  </script>
</head>

<body>
  <canvas id="canvas"></canvas>

  <script>
  var width = 640;
  var height = 480;
  var scale = 1;
  var startFrame = -1;
  var brow = 0, eye = 0, mouth = 0;
  var gamePart = 0;
  var count = 0;
  var veeCount = 0;
  var touch = false;
  var playingVee1 = [];

  function main(){
    var day = new Date();
    var lastFrame = day.getTime();
    var frame = (lastFrame-startFrame);
    if(frame < 0 || startFrame == -1) frame =0;
    startFrame = lastFrame;
    guruguru(frame);
    if(gamePart == 4) {
      if(getCurrentTime("bgm") > 20) {
        gamePart = 5;
        scale  = 1;
      }
      scale += frame/10000;
    }
    draw();
    checkSound()
    setTimeout(main, 0);
  }
  function draw() {
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext('2d');

    canvas.setAttribute("width", width);
    canvas.setAttribute("height", height);

    var sc;
    var cx = width/2;
    var cy = height/2;
    if(height / width < 0.75) {
      ctx.font =  height/9+"px 'ＭＳ ゴシック'";
      sc = height/480;
    } else {
      ctx.font =  width/12+"px 'ＭＳ ゴシック'";
      sc = width/640;
    }
    if(gamePart < 5) {
      var sx, sy, sw ,sh;
      sx = cx + (-320 + 0)*scale*sc; sy = cy + (-240 + 0)*scale*sc;
      sw = 640*sc*scale; sh = 480*sc*scale;
      ctx.drawImage(backGraph,sx ,sy ,sw ,sh );
      if(brow != -1) {
        sx = cx + (-320 + 180)*scale*sc; sy = cy + (-240 + 150)*scale*sc;
        sw = 260*sc*scale; sh = 70*sc*scale;
        ctx.drawImage(browGraph[brow],sx ,sy ,sw ,sh );
      }
      if(eye != -1) {
        sx = cx + (-320 + 180)*scale*sc; sy = cy + (-240 + 190)*scale*sc;
        sw = 260*sc*scale; sh = 100*sc*scale;
        ctx.drawImage(eyeGraph[eye],sx ,sy ,sw ,sh );
      }
      if(mouth != -1) {
        sx = cx + (-320 + 270)*scale*sc; sy = cy + (-240 + 310)*scale*sc;
        sw = 90*sc*scale; sh = 50*sc*scale;
        ctx.drawImage(mouthGraph[mouth],sx ,sy ,sw ,sh );
      }
          sx = cx + (-320 + 0)*scale*sc; sy = cy + (-240 + 0)*scale*sc;
      sw = 640*sc*scale; sh = 480*sc*scale;
      ctx.drawImage(hairGraph,sx ,sy ,sw ,sh );
    } else {
      ctx.fillStyle="#ffffff";
      ctx.fillText("真姫ちゃんかわいい", cx-300*sc, cy+70*sc);
    }
  }
  function guruguru(frame) {
    var speed = 150/frame;
    count++;
    switch(gamePart) {
    case 1:
      if(count > speed) count = 0;
      if (count == 0) {
        brow = (brow + 1) % 4;
        if(!touch) {
          veeCount = (veeCount+1)%3;
          playSound("vee1");
        }
      }
      break;
    case 2:
      if(count > speed/2) count = 0;
      if (count == 0) {
        mouth = (mouth + 1) % 4;
        if(getCurrentTime("vee2") > 0.58 && !touch) {
          veeCount = (veeCount+1)%3;
          playSound("vee1");
        }
      }
      break;
    case 3:
      if(count > speed/4) count = 0;
      if (count == 0) {
        eye = (eye + 1) % 4;
        if(getCurrentTime("vee2") > 0.58 && !touch) {
          veeCount = (veeCount+1)%3;
          playSound("vee1");
        }
      }
      break;
    }
    if(touch) {
      if(gamePart < 4) {
        if(gamePart > 0) {
          pauseAllVee1();
          playSound("vee2");

          if(gamePart == 3) {
            playSound("bgm");
          }
        }
        gamePart++;
        count = -1;
      }
      touch = false;
    }
  }
  $(window).resize(function() {
    width = $('body').width();
    height = $('body').height();
    draw();
  })

  function checkSound() {
    // if(playingVee1.length > 3) {
    // playtime = [0.45, 0.18, 0.08];
    for(var i=0; i<playingVee1.length; i++){
      var volume = (0.50-playingVee1[i].currentTime*gamePart)/0.5;
      if(volume < 0) volume = 0;
      playingVee1[i].volume = volume;
      // if(playingVee1[i].currentTime > playtime[gamePart-1]) {
      //   playingVee1[i].pause();
      //   playingVee1[i].currentTime = playingVee1[i].duration
      // }
    }
    //   playingVee1.splice(0, playingVee1.length - 3);
    // }
    for(var i in playingVee1) {
      if(playingVee1[i].currentTime == playingVee1[i].duration) {
        playingVee1.splice(i, 1);
      }
    }
  }

  function playSound(name) {
    var volume = {vee1: 0.5, vee2: 0.5, bgm: 0.7};
    audioList[name] = new Audio(audioSourceList[name]);
    audioList[name].volume = volume[name];
    audioList[name].currentTime = 0;
    audioList[name].play();

    if(name == "vee1") {
      playingVee1.push(audioList[name]);
    }
  }

  function getCurrentTime(name) {
    return audioList[name].currentTime;
  }

  function pauseAllVee1() {
    for(var i in playingVee1) {
      playingVee1[i].pause();
    }
    playingVee1 = [];
  }

  $(window).on('load', function(){
    width = $('body').width();
    height = $('body').height();

    var device = ["iPhone", "iPad", "iPod", "Android"];
    for(var i=0; i<device.length; i++){
      if (navigator.userAgent.indexOf(device[i])>0){
        $('#canvas').on('touchend', function() {
          if(gamePart == 0) {
            start();
          }
        });
        $('#canvas').on('touchstart', function() {
          touch = true;
        });
        break;
      }
      if(i == device.length-1) {
        $('#canvas').on('mousedown', function() {
          if(gamePart == 0) {
            start();
          }
          touch = true;
        });
      }
    };
    brow = getRand(0,3);
    eye = getRand(0,3);
    mouth = getRand(0,3);
    draw();
  });
  function start(){
    brow = 0;
    eye = -1;
    mouth = -1;
    main();
  }
  function getRand(max, min){
    var rand = Math.floor( Math.random() * (max + 1 - min) ) + min ;
    return rand;
  }
  </script>

  <style>
  html {
  user-select: none;
  }
  body {
    position: fixed;
    width: 100%;
    height: 100%;
    overflow: hidden;
    margin: 0px;
    background: #000;
  }
  #canvas {
  }
  img {
    position: absolute;
    visibility: hidden;
  }
  p {
    visibility: hidden;
    position: absolute;
    top: 0;
    left: 0;
    color: #fff;
    vertical-align: middle;
    font-size: 8vmin;
  }
  </style>
</body>
</html>
